<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Goals and Consistency</title>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        text-align: center;
        padding: 20px;
        background-color: #f7f7f9; /* Light background for neatness */
      }
      h1 {
        color: #9d46ff;
        margin-bottom: 20px;
      }
      /* --- Main Layout: Side-by-Side Flex Container --- */
      .main-container {
        display: flex;
        justify-content: center; /* Center the entire block */
        gap: 40px; /* Reduced space for a tighter, neater look */
        align-items: flex-start; /* Align to the top */
        max-width: 1100px; /* Increased max width for more space */
        margin: 0 auto; /* Center the container */
        padding: 20px;
      }
      .goals-section,
      .calendar-section {
        flex: 1; /* Take up equal space */
        min-width: 350px; /* Ensure sections don't get too small */
        max-width: 500px;
        text-align: left;
      }

      /* --- Goals Section Styles --- */
      .pending-goals-container,
      .completed-goals-container {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        background-color: white; /* White background for containers */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); /* Soft shadow */
      }
      .pending-goals-container h2,
      .completed-goals-container h2 {
        color: #9d46ff;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.5em;
      }
      .goal-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 1.05em;
      }
      .goal-item:last-child {
        border-bottom: none;
      }
      .goal-name {
        flex-grow: 1;
        padding-right: 10px;
        word-break: break-word; /* Prevent long names from breaking layout */
      }
      .completed-goal {
        color: #888;
        font-style: italic;
        text-decoration: line-through; /* Strikethrough for completed goals */
      }

      /* --- Action Buttons (Complete/Delete) --- */
      .complete-button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }
      .complete-button:hover {
        background-color: #45a049;
      }

      /* --- Add Goal Row and Buttons --- */
      .add-goal-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 18px; /* More space before list starts */
      }
      .add-goal-input {
        flex: 1;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 1em;
        outline: none;
        transition: box-shadow 0.15s ease, border-color 0.15s ease;
      }
      .add-goal-input:focus {
        box-shadow: 0 0 0 3px rgba(157, 70, 255, 0.2);
        border-color: #9d46ff;
      }
      .action-btn {
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95em;
        font-weight: 600;
        transition: background 0.2s ease, transform 0.08s ease;
      }
      .add-goal-btn {
        background: linear-gradient(90deg, #7c3aed, #06b6d4);
        color: white;
        white-space: nowrap; /* Prevent button text wrap */
      }
      .add-goal-btn:hover {
        transform: translateY(-2px);
      }
      .delete-goal-btn {
        background: #ef4444;
        color: white;
        margin-left: 8px; /* Spacing from goal name */
      }
      .delete-goal-btn:hover {
        background: #dc2626;
      }

      /* --- Calendar Section Styles --- */
      .calendar-section h2 {
        color: #9d46ff;
        margin-top: 15px;
        font-size: 1.5em;
      }
      .calendar-container {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        background-color: white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      .calendar-header select {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin: 0 5px;
      }
      #log-today {
        background: linear-gradient(90deg, #10b981, #06b6d4);
        color: white;
        border-radius: 8px;
        padding: 10px 15px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s ease;
      }
      #log-today:hover {
        transform: translateY(-2px);
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 3px;
        width: 100%; /* Take full width of its container */
      }
      .calendar-day {
        padding: 8px 0;
        border: 1px solid #f0f0f0;
        text-align: center;
        border-radius: 4px;
        font-size: 0.9em;
        cursor: pointer;
        transition: background-color 0.15s ease;
      }
      .calendar-day:hover:not(.inactive) {
        background-color: #f0f0f0;
      }
      .calendar-day.consistent {
        background-color: #a7f3d0; /* Light green for consistent days */
        color: #065f46;
        font-weight: bold;
        border-color: #6ee7b7;
      }
      .calendar-day.inactive {
        color: #ccc;
        cursor: default;
      }
      
      /* Day labels */
      .day-label {
        font-weight: bold;
        color: #9d46ff;
        padding: 5px 0;
        text-align: center;
      }

      /* Upvotes display */
      #upvotes {
        font-weight: bold;
        color: #3b82f6;
        font-size: 1.2em;
      }
    </style>
  </head>
  <body>
    <h1>Student Goals & Consistency Tracker</h1>
    <p>Total Upvotes: <span id="upvotes">0</span></p>
    <div class="main-container">
      <div class="goals-section">
        <div class="pending-goals-container">
          <h2>Pending Goals</h2>
          <div id="pending-goals"></div>
        </div>
        <div class="completed-goals-container">
          <h2>Completed Goals</h2>
          <div id="completed-goals"></div>
        </div>
      </div>

      <div class="calendar-section">
        <h2>Consistency Calendar</h2>
        <div class="calendar-container">
          <div class="calendar-header">
            <select id="year" aria-label="Select year"></select>
            <select id="month" aria-label="Select month">
              <option value="0">January</option>
              <option value="1">February</option>
              <option value="2">March</option>
              <option value="3">April</option>
              <option value="4">May</option>
              <option value="5">June</option>
              <option value="6">July</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">October</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>
            <button id="log-today" title="Log today's consistency">
              Log Today
            </button>
          </div>
          <div class="calendar-grid">
            <div class="day-label">Sun</div>
            <div class="day-label">Mon</div>
            <div class="day-label">Tue</div>
            <div class="day-label">Wed</div>
            <div class="day-label">Thu</div>
            <div class="day-label">Fri</div>
            <div class="day-label">Sat</div>
          </div>
          <div id="calendar-grid" class="calendar-grid"></div>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const upvotesSpan = document.getElementById("upvotes");
        const pendingGoalsDiv = document.getElementById("pending-goals");
        const completedGoalsDiv = document.getElementById("completed-goals");
        const yearSelect = document.getElementById("year");
        const monthSelect = document.getElementById("month");
        // NOTE: The new calendar structure uses two elements with the class 'calendar-grid'.
        // The one for the days must be identified uniquely. I'll select by ID which is correct.
        const calendarGrid = document.getElementById("calendar-grid");

        let goals = [];
        let isFetchingGoals = false;
        const urlParams = new URLSearchParams(window.location.search);
        const studentIdFromQuery = urlParams.get("studentId");

        const apiBase = "/api/goals";

        async function fetchGoals() {
          if (isFetchingGoals) return;
          isFetchingGoals = true;
          try {
            const query = studentIdFromQuery
              ? `?studentId=${encodeURIComponent(studentIdFromQuery)}`
              : "";
            const res = await fetch(`${apiBase}${query}`);
            if (!res.ok) throw new Error("Failed to load goals");
            const fresh = await res.json();
            // quick check to avoid unnecessary re-renders: compare lengths and ids
            const same =
              Array.isArray(fresh) &&
              fresh.length === goals.length &&
              fresh.every(
                (f, i) =>
                  f._id === goals[i]._id && f.completed === goals[i].completed
              );
            if (!same) {
              goals = fresh;
              renderPendingGoals();
              renderCompletedGoals();
            }
          } catch (err) {
            console.error("fetchGoals error", err);
          } finally {
            isFetchingGoals = false;
          }
        }
        // Function to render pending goals
        const renderPendingGoals = () => {
          pendingGoalsDiv.innerHTML = "";
          goals
            .filter((goal) => !goal.completed)
            .forEach((goal) => {
              const goalItem = document.createElement("div");
              goalItem.classList.add("goal-item");
              const goalName = document.createElement("span");
              goalName.classList.add("goal-name");
              goalName.textContent = goal.name;
              const completeButton = document.createElement("button");
              completeButton.classList.add("complete-button");
              completeButton.textContent = "Complete";
              completeButton.addEventListener("click", async () => {
                try {
                  const res = await fetch(`${apiBase}/${goal._id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ completed: true }),
                  });
                  if (!res.ok) throw new Error("update failed");
                  const updated = await res.json();
                  // update local list
                  goals = goals.map((g) =>
                    g._id === updated._id ? updated : g
                  );
                  renderPendingGoals();
                  renderCompletedGoals();
                } catch (err) {
                  console.error("complete goal error", err);
                }
              });
              goalItem.appendChild(goalName);
              goalItem.appendChild(completeButton);
              pendingGoalsDiv.appendChild(goalItem);
            });
        };

        // Function to render completed goals
        const renderCompletedGoals = () => {
          completedGoalsDiv.innerHTML = "";
          goals
            .filter((goal) => goal.completed)
            .forEach((goal) => {
              const goalItem = document.createElement("div");
              goalItem.classList.add("goal-item");
              const goalName = document.createElement("span");
              goalName.classList.add("goal-name", "completed-goal");
              goalName.textContent = goal.name;
              // add delete button for completed goals
              const delBtn = document.createElement("button");
              delBtn.textContent = "Delete";
              delBtn.style.marginLeft = "8px";
              delBtn.classList.add("action-btn", "delete-goal-btn");
              delBtn.addEventListener("click", async () => {
                try {
                  const res = await fetch(`${apiBase}/${goal._id}`, {
                    method: "DELETE",
                  });
                  if (!res.ok) throw new Error("delete failed");
                  goals = goals.filter((g) => g._id !== goal._id);
                  renderCompletedGoals();
                  renderPendingGoals();
                } catch (err) {
                  console.error("deleteGoal error", err);
                }
              });
              goalItem.appendChild(goalName);
              goalItem.appendChild(delBtn);
              completedGoalsDiv.appendChild(goalItem);
            });
        };

        // Hook up a simple add-goal form (UI)
        const addInput = document.createElement("input");
        addInput.placeholder = "New goal name";
        addInput.style.width = "70%";
        addInput.classList.add("add-goal-input");
        const addBtn = document.createElement("button");
        addBtn.textContent = "Add Goal";
        addBtn.style.marginLeft = "8px";
        addBtn.classList.add("action-btn", "add-goal-btn");
        addBtn.addEventListener("click", async () => {
          const name = addInput.value && addInput.value.trim();
          if (!name) return;
          try {
            const payload = { name };
            if (studentIdFromQuery) payload.studentId = studentIdFromQuery;
            const res = await fetch(apiBase, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error("create failed");
            const created = await res.json();
            goals.unshift(created);
            addInput.value = "";
            renderPendingGoals();
          } catch (err) {
            console.error("createGoal error", err);
          }
        });
        // insert inputs to the pending goals container header inside a single row
        const pendingHeader = document.querySelector(
          ".pending-goals-container"
        );
        const addRow = document.createElement("div");
        addRow.classList.add("add-goal-row");
        addRow.appendChild(addInput);
        addRow.appendChild(addBtn);
        // Find the h2 element to insert the row before it
        const pendingH2 = pendingHeader.querySelector("h2");
        pendingHeader.insertBefore(addRow, pendingH2);

        // load goals from API initially
        fetchGoals();

        // Poll goals every 15 seconds and re-render
        const GOALS_POLL_INTERVAL = 15000; // ms
        let goalsPollId = setInterval(fetchGoals, GOALS_POLL_INTERVAL);

        // Pause polling when tab is hidden to save resources, resume when visible
        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            if (goalsPollId) {
              clearInterval(goalsPollId);
              goalsPollId = null;
            }
          } else {
            if (!goalsPollId)
              goalsPollId = setInterval(fetchGoals, GOALS_POLL_INTERVAL);
          }
        });

        // Populate year options (current year - 5 to current year + 5)
        const currentYear = new Date().getFullYear();
        for (let i = currentYear - 5; i <= currentYear + 5; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          if (i === currentYear) {
            option.selected = true;
          }
          yearSelect.appendChild(option);
        }

        // Consistency (persisted) handling
        const consistencyApi = "/api/consistency";
        let consistencyDates = []; // all dates for the student: ['YYYY-MM-DD', ...]

        const pad2 = (n) => (n < 10 ? "0" + n : "" + n);

        // Load persisted consistency dates for the student
        async function loadConsistencyDates() {
          try {
            const query = studentIdFromQuery
              ? `?studentId=${encodeURIComponent(studentIdFromQuery)}`
              : "";
            const res = await fetch(`${consistencyApi}${query}`);
            if (!res.ok) throw new Error("Failed to load consistency dates");
            const dates = await res.json();
            // API returns array of YYYY-MM-DD strings
            consistencyDates = Array.isArray(dates) ? dates : [];
          } catch (err) {
            console.error("loadConsistencyDates error", err);
            consistencyDates = [];
          }
        }

        const datesForMonth = (year, month) => {
          const prefix = `${year}-${pad2(month + 1)}-`;
          return consistencyDates.filter((d) => d.startsWith(prefix));
        };

        // Function to render the calendar
        const renderCalendar = (year, month, consistentDays) => {
          const firstDayOfMonth = new Date(year, month, 1);
          const lastDayOfMonth = new Date(year, month + 1, 0);
          const daysInMonth = lastDayOfMonth.getDate();
          const startingDay = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.
          calendarGrid.innerHTML = ""; // Clear previous calendar days

          // Create empty cells for the days before the first day of the month
          for (let i = 0; i < startingDay; i++) {
            const emptyCell = document.createElement("div");
            emptyCell.classList.add("calendar-day", "inactive");
            calendarGrid.appendChild(emptyCell);
          }

          // Create cells for each day of the month
          for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement("div");
            dayCell.classList.add("calendar-day");
            dayCell.textContent = day;
            const currentDate = new Date(year, month, day)
              .toISOString()
              .slice(0, 10); // Format as YYYY-MM-DD
            dayCell.dataset.date = currentDate;
            if (consistentDays.includes(currentDate)) {
              dayCell.classList.add("consistent");
            }
            // toggle on click: add or remove date
            dayCell.addEventListener("click", async () => {
              try {
                const isConsistent = consistencyDates.includes(currentDate);
                if (isConsistent) {
                  // remove
                  const payload = {};
                  if (studentIdFromQuery)
                    payload.studentId = studentIdFromQuery;
                  payload.date = currentDate;
                  const res = await fetch(consistencyApi, {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                  });
                  if (!res.ok) throw new Error("Failed to remove date");
                  // update local
                  consistencyDates = consistencyDates.filter(
                    (d) => d !== currentDate
                  );
                  dayCell.classList.remove("consistent");
                } else {
                  // add
                  const payload = { date: currentDate };
                  if (studentIdFromQuery)
                    payload.studentId = studentIdFromQuery;
                  const res = await fetch(consistencyApi, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                  });
                  if (!res.ok) throw new Error("Failed to add date");
                  // update local
                  consistencyDates.push(currentDate);
                  dayCell.classList.add("consistent");
                }
              } catch (err) {
                console.error("toggle date error", err);
              }
            });

            calendarGrid.appendChild(dayCell);
          }
        };

        // Initial rendering of goals and calendar
        upvotesSpan.textContent = 125; // Sample upvotes
        renderPendingGoals();
        renderCompletedGoals();
        const initialDate = new Date();
        const initialYear = initialDate.getFullYear();
        const initialMonth = initialDate.getMonth();
        monthSelect.value = initialMonth; // Set the initial month in the dropdown

        // Load persisted consistency dates then render calendar for initial month
        (async () => {
          await loadConsistencyDates();
          renderCalendar(
            initialYear,
            initialMonth,
            datesForMonth(initialYear, initialMonth)
          );
          // If ?markToday=1 provided, auto-log today's date
          const markToday = urlParams.get("markToday");
          if (markToday === "1") {
            // fire-and-forget
            logToday().catch((e) => console.error("auto logToday failed", e));
          }
        })();

        // Helper: log today's date via API
        async function logToday() {
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = pad2(today.getMonth() + 1);
          const dd = pad2(today.getDate());
          const dateStr = `${yyyy}-${mm}-${dd}`;
          try {
            const payload = { date: dateStr };
            if (studentIdFromQuery) payload.studentId = studentIdFromQuery;
            const res = await fetch(consistencyApi, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error("Failed to log today");
            // refresh local dates and re-render current month
            await loadConsistencyDates();
            const y = Number(yearSelect.value);
            const m = Number(monthSelect.value);
            renderCalendar(y, m, datesForMonth(y, m));
          } catch (err) {
            console.error("logToday error", err);
          }
        }

        // Wire Log Today button
        const logTodayBtn = document.getElementById("log-today");
        if (logTodayBtn) {
          logTodayBtn.addEventListener("click", async () => {
            await logToday();
          });
        }

        // Event listeners for year and month changes to re-render the calendar
        yearSelect.addEventListener("change", async () => {
          const y = Number(yearSelect.value);
          const m = Number(monthSelect.value);
          await loadConsistencyDates();
          renderCalendar(y, m, datesForMonth(y, m));
        });

        monthSelect.addEventListener("change", async () => {
          const y = Number(yearSelect.value);
          const m = Number(monthSelect.value);
          await loadConsistencyDates();
          renderCalendar(y, m, datesForMonth(y, m));
        });
      });
    </script>
  </body>
</html>