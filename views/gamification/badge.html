<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Goals and Consistency</title>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        text-align: center;
        padding: 20px;
      }
      h1 {
        color: #9d46ff;
        margin-bottom: 20px;
      }
      .main-container {
        display: flex;
        gap: 100px; /* Space between goals and calendar */
        align-items: flex-start; /* Align to the top */
        max-width: 900px; /* Limit the overall width */
        margin: 0 auto; /* Center the container */
      }
      .goals-section {
        flex: 1; /* Take up equal space */
        text-align: left;
      }
      .pending-goals-container,
      .completed-goals-container {
        margin-top: 10px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .pending-goals-container h2,
      .completed-goals-container h2 {
        color: #9d46ff;
        margin-top: 0;
        margin-bottom: 10px;
      }
      .goal-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .goal-item:last-child {
        border-bottom: none;
      }
      .goal-name {
        flex-grow: 1;
      }
      .complete-button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }
      .complete-button:hover {
        background-color: #45a049;
      }
      .completed-goal {
        color: #888;
        font-style: italic;
      }
      .calendar-section {
        flex: 1; /* Take up equal space */
        text-align: center;
      }
      .calendar-container {
        margin-top: 10px;
      }
      .calendar-header {
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
      }
      .calendar-header select {
        padding: 8px;
        margin: 0 10px;
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        width: 90%; /* Make calendar take full width of its container */
      }
      .calendar-day {
        padding: 5px;
        border: 1px solid #eee;
        text-align: center;
      }
      .calendar-day.consistent {
        background-color: #a7f3d0; /* Light green for consistent days */
        font-weight: bold;
      }
      .calendar-day.inactive {
        color: #ccc;
      }
      h2 {
        margin-top: 15px;
        color: #9d46ff;
      }
      #upvotes {
        font-weight: bold;
        color: #3b82f6;
      }
    </style>
  </head>
  <body>
    <h1>Student Goals</h1>
    <p>Total Upvotes: <span id="upvotes">0</span></p>
    <div class="main-container">
      <div class="goals-section">
        <div class="pending-goals-container">
          <h2>Pending Goals</h2>
          <div id="pending-goals"></div>
        </div>
        <div class="completed-goals-container">
          <h2>Completed Goals</h2>
          <div id="completed-goals"></div>
        </div>
      </div>
      <div class="calendar-section">
        <h2>Consistency Calendar</h2>
        <div class="calendar-header">
          <select id="year" aria-label="Select year"></select>
          <select id="month" aria-label="Select month">
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
          </select>
          <button id="log-today" title="Log today's consistency">
            Log Today
          </button>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const upvotesSpan = document.getElementById("upvotes");
        const pendingGoalsDiv = document.getElementById("pending-goals");
        const completedGoalsDiv = document.getElementById("completed-goals");
        const yearSelect = document.getElementById("year");
        const monthSelect = document.getElementById("month");
        const calendarGrid = document.getElementById("calendar-grid");

        // Goals will be loaded from the API
        let goals = [];
        // Optional: provide studentId via query string for testing, otherwise server session is used
        const urlParams = new URLSearchParams(window.location.search);
        const studentIdFromQuery = urlParams.get("studentId");

        const apiBase = "/api/goals";

        async function fetchGoals() {
          try {
            const query = studentIdFromQuery
              ? `?studentId=${encodeURIComponent(studentIdFromQuery)}`
              : "";
            const res = await fetch(`${apiBase}${query}`);
            if (!res.ok) throw new Error("Failed to load goals");
            goals = await res.json();
            renderPendingGoals();
            renderCompletedGoals();
          } catch (err) {
            console.error("fetchGoals error", err);
          }
        }
        // Function to render pending goals
        const renderPendingGoals = () => {
          pendingGoalsDiv.innerHTML = "";
          goals
            .filter((goal) => !goal.completed)
            .forEach((goal) => {
              const goalItem = document.createElement("div");
              goalItem.classList.add("goal-item");
              const goalName = document.createElement("span");
              goalName.classList.add("goal-name");
              goalName.textContent = goal.name;
              const completeButton = document.createElement("button");
              completeButton.classList.add("complete-button");
              completeButton.textContent = "Complete";
              completeButton.addEventListener("click", async () => {
                try {
                  const res = await fetch(`${apiBase}/${goal._id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ completed: true }),
                  });
                  if (!res.ok) throw new Error("update failed");
                  const updated = await res.json();
                  // update local list
                  goals = goals.map((g) =>
                    g._id === updated._id ? updated : g
                  );
                  renderPendingGoals();
                  renderCompletedGoals();
                } catch (err) {
                  console.error("complete goal error", err);
                }
              });
              goalItem.appendChild(goalName);
              goalItem.appendChild(completeButton);
              pendingGoalsDiv.appendChild(goalItem);
            });
        };

        // Function to render completed goals
        const renderCompletedGoals = () => {
          completedGoalsDiv.innerHTML = "";
          goals
            .filter((goal) => goal.completed)
            .forEach((goal) => {
              const goalItem = document.createElement("div");
              goalItem.classList.add("goal-item");
              const goalName = document.createElement("span");
              goalName.classList.add("goal-name", "completed-goal");
              goalName.textContent = goal.name;
              // add delete button for completed goals
              const delBtn = document.createElement("button");
              delBtn.textContent = "Delete";
              delBtn.style.marginLeft = "8px";
              delBtn.addEventListener("click", async () => {
                try {
                  const res = await fetch(`${apiBase}/${goal._id}`, {
                    method: "DELETE",
                  });
                  if (!res.ok) throw new Error("delete failed");
                  goals = goals.filter((g) => g._id !== goal._id);
                  renderCompletedGoals();
                  renderPendingGoals();
                } catch (err) {
                  console.error("deleteGoal error", err);
                }
              });
              goalItem.appendChild(goalName);
              goalItem.appendChild(delBtn);
              completedGoalsDiv.appendChild(goalItem);
            });
        };

        // Hook up a simple add-goal form (UI)
        const addInput = document.createElement("input");
        addInput.placeholder = "New goal name";
        addInput.style.width = "70%";
        const addBtn = document.createElement("button");
        addBtn.textContent = "Add Goal";
        addBtn.style.marginLeft = "8px";
        addBtn.addEventListener("click", async () => {
          const name = addInput.value && addInput.value.trim();
          if (!name) return;
          try {
            const payload = { name };
            if (studentIdFromQuery) payload.studentId = studentIdFromQuery;
            const res = await fetch(apiBase, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error("create failed");
            const created = await res.json();
            goals.unshift(created);
            addInput.value = "";
            renderPendingGoals();
          } catch (err) {
            console.error("createGoal error", err);
          }
        });
        // insert inputs to the pending goals container header
        const pendingHeader = document.querySelector(
          ".pending-goals-container"
        );
        pendingHeader.insertBefore(addInput, pendingHeader.firstChild);
        pendingHeader.insertBefore(
          addBtn,
          pendingHeader.firstChild.nextSibling
        );

        // load goals from API initially
        fetchGoals();

        // Populate year options (current year - 5 to current year + 5)
        const currentYear = new Date().getFullYear();
        for (let i = currentYear - 5; i <= currentYear + 5; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          if (i === currentYear) {
            option.selected = true;
          }
          yearSelect.appendChild(option);
        }

        // Consistency (persisted) handling
        const consistencyApi = "/api/consistency";
        let consistencyDates = []; // all dates for the student: ['YYYY-MM-DD', ...]

        const pad2 = (n) => (n < 10 ? "0" + n : "" + n);

        // Load persisted consistency dates for the student
        async function loadConsistencyDates() {
          try {
            const query = studentIdFromQuery
              ? `?studentId=${encodeURIComponent(studentIdFromQuery)}`
              : "";
            const res = await fetch(`${consistencyApi}${query}`);
            if (!res.ok) throw new Error("Failed to load consistency dates");
            const dates = await res.json();
            // API returns array of YYYY-MM-DD strings
            consistencyDates = Array.isArray(dates) ? dates : [];
          } catch (err) {
            console.error("loadConsistencyDates error", err);
            consistencyDates = [];
          }
        }

        const datesForMonth = (year, month) => {
          const prefix = `${year}-${pad2(month + 1)}-`;
          return consistencyDates.filter((d) => d.startsWith(prefix));
        };

        // Function to render the calendar
        const renderCalendar = (year, month, consistentDays) => {
          const firstDayOfMonth = new Date(year, month, 1);
          const lastDayOfMonth = new Date(year, month + 1, 0);
          const daysInMonth = lastDayOfMonth.getDate();
          const startingDay = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.
          calendarGrid.innerHTML = ""; // Clear previous calendar

          // Create empty cells for the days before the first day of the month
          for (let i = 0; i < startingDay; i++) {
            const emptyCell = document.createElement("div");
            emptyCell.classList.add("calendar-day", "inactive");
            calendarGrid.appendChild(emptyCell);
          }

          // Create cells for each day of the month
          for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement("div");
            dayCell.classList.add("calendar-day");
            dayCell.textContent = day;
            const currentDate = new Date(year, month, day)
              .toISOString()
              .slice(0, 10); // Format as YYYY-MM-DD
            dayCell.dataset.date = currentDate;
            if (consistentDays.includes(currentDate)) {
              dayCell.classList.add("consistent");
            }
            // toggle on click: add or remove date
            dayCell.addEventListener("click", async () => {
              try {
                const isConsistent = consistencyDates.includes(currentDate);
                if (isConsistent) {
                  // remove
                  const payload = {};
                  if (studentIdFromQuery)
                    payload.studentId = studentIdFromQuery;
                  payload.date = currentDate;
                  const res = await fetch(consistencyApi, {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                  });
                  if (!res.ok) throw new Error("Failed to remove date");
                  // update local
                  consistencyDates = consistencyDates.filter(
                    (d) => d !== currentDate
                  );
                  dayCell.classList.remove("consistent");
                } else {
                  // add
                  const payload = { date: currentDate };
                  if (studentIdFromQuery)
                    payload.studentId = studentIdFromQuery;
                  const res = await fetch(consistencyApi, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                  });
                  if (!res.ok) throw new Error("Failed to add date");
                  // update local
                  consistencyDates.push(currentDate);
                  dayCell.classList.add("consistent");
                }
              } catch (err) {
                console.error("toggle date error", err);
              }
            });

            calendarGrid.appendChild(dayCell);
          }
        };

        // Initial rendering of goals and calendar
        upvotesSpan.textContent = 125; // Sample upvotes
        renderPendingGoals();
        renderCompletedGoals();
        const initialYear = new Date().getFullYear();
        const initialMonth = new Date().getMonth();
        monthSelect.value = initialMonth; // Set the initial month in the dropdown

        // Load persisted consistency dates then render calendar for initial month
        (async () => {
          await loadConsistencyDates();
          renderCalendar(
            initialYear,
            initialMonth,
            datesForMonth(initialYear, initialMonth)
          );
          // If ?markToday=1 provided, auto-log today's date
          const markToday = urlParams.get("markToday");
          if (markToday === "1") {
            // fire-and-forget
            logToday().catch((e) => console.error("auto logToday failed", e));
          }
        })();

        // Helper: log today's date via API
        async function logToday() {
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = pad2(today.getMonth() + 1);
          const dd = pad2(today.getDate());
          const dateStr = `${yyyy}-${mm}-${dd}`;
          try {
            const payload = { date: dateStr };
            if (studentIdFromQuery) payload.studentId = studentIdFromQuery;
            const res = await fetch(consistencyApi, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error("Failed to log today");
            // refresh local dates and re-render current month
            await loadConsistencyDates();
            const y = Number(yearSelect.value);
            const m = Number(monthSelect.value);
            renderCalendar(y, m, datesForMonth(y, m));
          } catch (err) {
            console.error("logToday error", err);
          }
        }

        // Wire Log Today button
        const logTodayBtn = document.getElementById("log-today");
        if (logTodayBtn) {
          logTodayBtn.addEventListener("click", async () => {
            await logToday();
          });
        }

        // Event listeners for year and month changes to re-render the calendar
        yearSelect.addEventListener("change", async () => {
          const y = Number(yearSelect.value);
          const m = Number(monthSelect.value);
          await loadConsistencyDates();
          renderCalendar(y, m, datesForMonth(y, m));
        });

        monthSelect.addEventListener("change", async () => {
          const y = Number(yearSelect.value);
          const m = Number(monthSelect.value);
          await loadConsistencyDates();
          renderCalendar(y, m, datesForMonth(y, m));
        });
      });
    </script>
  </body>
</html>
