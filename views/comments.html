<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comment Forum</title>
  <style>
    body { font-family: Arial; background: #f2f2f2; padding: 20px; }
    .comment { border: 1px solid #ccc; padding: 10px; margin-top: 10px; background: #fff; }
    .reply { margin-left: 30px; }
    .actions { margin-top: 5px; }
    button { margin-right: 5px; }
  </style>
</head>
<body>
  <h2>Discussion</h2>
  <div>
    <textarea id="newComment" rows="3" cols="50" placeholder="Write a comment..."></textarea><br>
    <button onclick="postComment()">Post Comment</button>
  </div>
  <div id="comments"></div>

  <script>
    
        function getUserIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('userId');  // This will return the value of 'userId' parameter
    }

    function getmoduleIdFromUrl(){
      const params = new URLSearchParams(window.location.search);
      return params.get('moduleId');  // This will return the value of 'userId' parameter
    }

    const API_URL = 'http://localhost:4000/coms';
    const videoId = getmoduleIdFromUrl();
    const userId = getUserIdFromUrl(); // assume logged in as user ID 1
    console.log(getUserIdFromUrl());
    console.log(getmoduleIdFromUrl());

    async function fetchComments() {
      const res = await fetch(`${API_URL}/comments/${videoId}`);
      const data = await res.json();
      const root = document.getElementById('comments');
      root.innerHTML = '';
      const map = {};
      data.forEach(c => map[c.id] = { ...c, replies: [] });
      data.forEach(c => {
        if (c.parent_id) {
          map[c.parent_id].replies.push(map[c.id]);
        }
      });
      Object.values(map).forEach(c => {
        if (!c.parent_id) root.appendChild(renderComment(c));
      });
    }

    function renderComment(c, isReply = false) {
      const div = document.createElement('div');
      div.className = 'comment' + (isReply ? ' reply' : '');
      div.innerHTML = `
        <strong>${c.name}</strong> ‚Äî <small>${new Date(c.created_at).toLocaleString()}</small><br>
        <p>${c.content}</p>
        <div class="actions">
          <span>Score: ${c.score}</span>
          <button onclick="vote(${c.id}, 1)">üëç</button>
          <button onclick="vote(${c.id}, -1)">üëé</button>
          <button onclick="showReplyForm(${c.id})">Reply</button>
          <div id="reply-${c.id}"></div>
        </div>
      `;
      c.replies.forEach(r => div.appendChild(renderComment(r, true)));
      return div;
    }

    async function postComment(parentId = null) {
      const textarea = parentId ? document.getElementById(`input-${parentId}`) : document.getElementById('newComment');
      const content = textarea.value.trim();
      if (!content) return;
      await fetch(`${API_URL}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, videoId, content, parentId })
      });
      textarea.value = '';
      fetchComments();
    }

    async function vote(commentId, value) {
      await fetch(`${API_URL}/comments/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, commentId, vote: value })
      });
      fetchComments();
    }

    function showReplyForm(parentId) {
      const div = document.getElementById(`reply-${parentId}`);
      div.innerHTML = `
        <textarea id="input-${parentId}" rows="2" cols="40" placeholder="Write a reply..."></textarea><br>
        <button onclick="postComment(${parentId})">Reply</button>
      `;
    }

    fetchComments();
  </script>
</body>
</html>
