<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Management - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            color: white;
        }
        .nav-link {
            color: rgba(255,255,255,.8);
        }
        .nav-link:hover {
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0 sidebar">
                <div class="p-3">
                    <h4>Admin Panel</h4>
                    <hr>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/-nsstn123-admin/dashboard">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/-nsstn123-admin/payments">
                                <i class="fas fa-dollar-sign me-2"></i>payment
                            </a>
                        <li class="nav-item">
                            <a class="nav-link" href="/-nsstn123-admin/users">
                                <i class="fas fa-users me-2"></i>Users
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/-nsstn123-admin/courses">
                                <i class="fas fa-book me-2"></i>Courses
                            </a>
                        </li>
                         <li class="nav-item">
                            <a class="nav-link active" href="/-nsstn123-admin/requests">
                                <i class="fas fa-envelope me-2"></i>Requests
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/-nsstn123-admin/content">
                                <i class="fas fa-file-alt me-2"></i>Content
                            </a>
                        </li>
                        <li class="nav-item mt-4">
                            <a class="nav-link text-danger" href="/-nsstn123-admin/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Content Management</h2>
    <div>
        <button class="btn btn-secondary me-2" id="refreshContentBtn">
            <i class="fas fa-sync-alt me-2"></i>Refresh
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addContentModal">
            <i class="fas fa-plus me-2"></i>Add New Content
        </button>
    </div>
</div>


                <!-- Search and Filter -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" class="form-control" placeholder="Search content...">
                            </div>
                            <div class="col-md-6">
                                <select class="form-select">
                                    <option value="">All Courses</option>
                                    <!-- Will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Course</th>
                                        <th>Content</th>
                                        <th>URL</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (modules && modules.length > 0) { %>
                                        <% modules.forEach(module => { %>
                                            <tr data-id="<%= module._id %>">
                                                <td><%= module.title %></td>
                                                <td><%= module.course_title %></td>
                                                <td><%= module.text %></td>
                                                <td>
                                                    <% if (module.url) { %>
                                                        <a href="<%= module.url %>" target="_blank" class="btn btn-sm btn-link">
                                                            <i class="fas fa-external-link-alt"></i> View
                                                        </a>
                                                    <% } else { %>
                                                        <span class="text-muted">No URL</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-info me-2">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="5" class="text-center">No content found</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Content Modal -->
    <div class="modal fade" id="addContentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Content</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="/-nsstn123-admin/content" method="POST">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" name="title" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Course</label>
                            <select name="course_id" class="form-select" required>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Content</label>
                            <textarea name="text" class="form-control" rows="4"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">URL (optional)</label>
                            <input type="url" name="url" class="form-control">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Content</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Content Modal -->
    <div class="modal fade" id="editContentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Content</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editContentForm">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" name="title" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Course</label>
                            <select name="course_id" class="form-select" required>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Content</label>
                            <textarea name="text" class="form-control" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">URL (optional)</label>
                            <input type="url" name="url" class="form-control">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
document.addEventListener('DOMContentLoaded', function() {

    async function populateCourses() {
        try {
            const response = await fetch('/-nsstn123-admin/courses/list');
            const courses = await response.json();
            const selects = document.querySelectorAll('select[name="course_id"]');
            selects.forEach(select => {
                while (select.options.length > 1) select.remove(1);
                courses.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c._id;
                    opt.textContent = c.title;
                    select.appendChild(opt);
                });
            });
        } catch (err) {
            console.error('Error fetching courses:', err);
        }
    }

    async function refreshContentTable() {
        try {
            const res = await fetch('/-nsstn123-admin/content/data');
            const modules = await res.json();
            const tbody = document.querySelector('table tbody');
            tbody.innerHTML = '';
            if (!modules.length) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center">No content found</td></tr>`;
                return;
            }

            modules.forEach(mod => {
                const tr = document.createElement('tr');
                tr.dataset.id = mod._id;
                tr.innerHTML = `
                    <td>${mod.title}</td>
                    <td>${mod.course_title}</td>
                    <td>${mod.text}</td>
                    <td>${mod.url ? `<a href="${mod.url}" target="_blank" class="btn btn-sm btn-link"><i class="fas fa-external-link-alt"></i> View</a>` : '<span class="text-muted">No URL</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-info edit-btn"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-btn"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            bindContentActions();
        } catch (err) {
            console.error(err);
        }
    }

    function bindContentActions() {
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.onclick = async function() {
                const row = this.closest('tr');
                const id = row.dataset.id;
                if (confirm('Delete this content?')) {
                    try {
                        const res = await fetch(`/-nsstn123-admin/content/${id}`, { method:'DELETE', headers:{'Content-Type':'application/json'} });
                        const data = await res.json();
                        if (data.success) row.remove();
                        else alert('Delete failed');
                    } catch(err) { console.error(err); alert('Delete failed'); }
                }
            };
        });

        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.onclick = function() {
                const row = this.closest('tr');
                const id = row.dataset.id;
                const form = document.getElementById('editContentForm');
                form.dataset.id = id;
                form.title.value = row.cells[0].textContent;

                const courseSelect = form.course_id;
                for (let opt of courseSelect.options) {
                    opt.selected = opt.textContent === row.cells[1].textContent;
                }

                form.text.value = row.cells[2].textContent;
                form.url.value = row.cells[3].querySelector('a')?.href || '';
                new bootstrap.Modal(document.getElementById('editContentModal')).show();
            };
        });

        // Filter/Search
        const searchInput = document.querySelector('input[placeholder="Search content..."]');
        const courseFilter = document.querySelector('select');
        const tableRows = document.querySelectorAll('tbody tr');

        function filterTable() {
            const term = searchInput.value.toLowerCase();
            const selected = courseFilter.value.toLowerCase();
            document.querySelectorAll('tbody tr').forEach(row => {
                const title = row.cells[0].textContent.toLowerCase();
                const course = row.cells[1].textContent.toLowerCase();
                const text = row.cells[2].textContent.toLowerCase();
                const show = (title.includes(term) || text.includes(term)) && (!selected || course === selected);
                row.style.display = show ? '' : 'none';
            });
        }

        if(searchInput) searchInput.addEventListener('input', filterTable);
        if(courseFilter) courseFilter.addEventListener('change', filterTable);
    }

    populateCourses();
    refreshContentTable();
const refreshBtn = document.getElementById('refreshContentBtn');
if (refreshBtn) {
    refreshBtn.addEventListener('click', () => {
        refreshContentTable();
    });
}
 setInterval(() => {
    refreshContentTable();
  }, 15000);

    const editForm = document.getElementById('editContentForm');
    if(editForm){
        editForm.addEventListener('submit', async e => {
            e.preventDefault();
            const id = editForm.dataset.id;
            const data = Object.fromEntries(new FormData(editForm).entries());
            try {
                const res = await fetch(`/-nsstn123-admin/content/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
                const result = await res.json();
                if(result.success){
                    refreshContentTable();
                    bootstrap.Modal.getInstance(document.getElementById('editContentModal')).hide();
                } else alert('Update failed');
            } catch(err){ console.error(err); alert('Update failed'); }
        });
    }

});
</script>

</body>
</html> 
