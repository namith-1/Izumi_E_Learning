<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Instructor Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #1e1e1e;
      color: #f0f0f0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .dashboard-container {
      width: 100%;
      max-width: 900px;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap; /* Helps with responsiveness */
    }
    .course-select {
      padding: 10px;
      background: #333;
      color: white;
      border: 1px solid #555;
      border-radius: 5px;
      font-size: 1em;
    }
    .range-selector button {
      padding: 8px 16px;
      margin-left: 5px;
      background: #333;
      color: white;
      border: 1px solid #555;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .range-selector button:hover {
      background: #4f46e5;
    }
    .range-selector button.active {
      background-color: #4f46e5;
      font-weight: bold;
    }
    .summary-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    .summary-card {
        background: #2a2a2a;
        padding: 20px;
        border-radius: 10px;
    }
    .summary-card h4 {
        margin: 0 0 10px 0;
        color: #aaa;
        font-weight: 400;
    }
    .summary-card p {
        margin: 0;
        font-size: 1.8em;
        font-weight: 600;
    }
    .chart-container {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      height: 350px; 
    }
    .course-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      width: 100%;
    }
    .course-card {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      border-left: 5px solid #4f46e5;
    }
    .course-card h3 {
      margin-top: 0;
    }
    .status-message {
      text-align: center;
      color: #aaa;
      padding: 40px;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h1>Instructor Dashboard</h1>

    <div class="controls">
      <select id="courseDropdown" class="course-select"></select>
      <div id="rangeSelector" class="range-selector">
        <button data-range="7d" class="active">7 Days</button>
        <button data-range="30d">30 Days</button>
        <button data-range="1y">1 Year</button>
      </div>
    </div>

    <div class="summary-container">
        <div class="summary-card">
            <h4>Total Enrollments</h4>
            <p id="totalEnrollments">--</p>
        </div>
        <div class="summary-card">
            <h4>Total Revenue</h4>
            <p id="totalRevenue">--</p>
        </div>
    </div>

    <div class="chart-container">
      <canvas id="enrollChart"></canvas>
    </div>

    <h2>Course Overview</h2>
    <div class="course-container" id="courseList"></div>
  </div>

  <script>
    const courseDropdown = document.getElementById('courseDropdown');
    const courseListContainer = document.getElementById('courseList');
    const chartCanvas = document.getElementById('enrollChart');
    const rangeSelector = document.getElementById('rangeSelector');
    const chartContainer = document.querySelector('.chart-container');
    const totalEnrollmentsEl = document.getElementById('totalEnrollments');
    const totalRevenueEl = document.getElementById('totalRevenue');

    let enrollChartInstance = null;

    async function fetchInstructorCourses() {
      courseListContainer.innerHTML = '<p class="status-message">Loading courses...</p>';
      try {
        const res = await fetch('http://localhost:4000/instructor/courses2');
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const courses = await res.json();

        courseDropdown.innerHTML = '';
        courseListContainer.innerHTML = '';

        if (courses.length === 0) {
          courseListContainer.innerHTML = '<p class="status-message">You have not created any courses yet.</p>';
          chartContainer.style.display = 'none';
          document.querySelector('.summary-container').style.display = 'none';
          return;
        }

        chartContainer.style.display = 'block';
        document.querySelector('.summary-container').style.display = 'grid';

        courses.forEach(course => {
          const option = document.createElement('option');
          option.value = course._id;
          option.textContent = course.title;
          courseDropdown.appendChild(option);

          const card = document.createElement('div');
          card.classList.add('course-card');
          card.innerHTML = `
            <h3>${course.title}</h3>
            <p><strong>Enrolled:</strong> ${course.enrolled_count.toLocaleString()}</p>
            <p><strong>Revenue:</strong> $${course.revenue.toLocaleString()}</p>
          `;
          courseListContainer.appendChild(card);
        });

        if (courses.length > 0) {
          const activeRange = document.querySelector('#rangeSelector button.active').dataset.range;
          fetchCourseStats(courses[0]._id, activeRange);
        }
      } catch (error) {
        console.error("Failed to fetch instructor courses:", error);
        courseListContainer.innerHTML = `<p class="status-message">Could not load courses. Please try again later.</p>`;
      }
    }

    async function fetchCourseStats(courseId, range = '7d') {
      try {
        const res = await fetch(`http://localhost:4000/instructor/course2/${courseId}/stats?range=${range}`);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json(); 

        let labels = [];
        let enrollmentValues = [];
        const AVG_PRICE = 49.99; // Assume an average price

        if (range === '1y') {
          const monthlySummary = {};
          data.forEach(item => {
            const monthKey = item._id.substring(0, 7); // "YYYY-MM"
            if (!monthlySummary[monthKey]) {
              monthlySummary[monthKey] = 0;
            }
            monthlySummary[monthKey] += item.enrollments;
          });

          const today = new Date();
          for (let i = 11; i >= 0; i--) {
            const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
            const monthKey = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
            const label = d.toLocaleString('default', { month: 'short', year: 'numeric' });
            
            labels.push(label);
            enrollmentValues.push(monthlySummary[monthKey] || 0);
          }
        } else {
          const dailyMap = new Map(data.map(item => [item._id, item.enrollments]));
          const days = parseInt(range);
          const today = new Date();

          for (let i = days - 1; i >= 0; i--) {
            const d = new Date();
            d.setDate(today.getDate() - i);
            
            // --- CORRECTED PART ---
            // Manually format the date to YYYY-MM-DD to avoid timezone issues.
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0'); // getMonth() is 0-indexed
            const day = String(d.getDate()).padStart(2, '0');
            const dateString = `${year}-${month}-${day}`;
            // --- END CORRECTION ---
            
            labels.push(d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
            enrollmentValues.push(dailyMap.get(dateString) || 0);
          }
        }

        const totalEnrollments = enrollmentValues.reduce((sum, current) => sum + current, 0);
        const totalRevenue = totalEnrollments * AVG_PRICE;
        totalEnrollmentsEl.textContent = totalEnrollments.toLocaleString();
        totalRevenueEl.textContent = totalRevenue.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

        const ctx = chartCanvas.getContext('2d');
        if (enrollChartInstance) {
          enrollChartInstance.destroy();
        }

        enrollChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Enrollments',
                data: enrollmentValues,
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.2)',
                fill: true,
                tension: 0.1,
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { 
                beginAtZero: true, 
                ticks: { 
                  color: '#f0f0f0',
                  // Ensure y-axis only shows whole numbers
                  callback: function(value) {if (value % 1 === 0) {return value;}}
                }, 
                grid: { color: 'rgba(255, 255, 255, 0.1)' } 
              },
              x: { 
                ticks: { color: '#f0f0f0' }, 
                grid: { color: 'rgba(255, 255, 255, 0.1)' } 
              }
            },
            plugins: { 
              legend: { labels: { color: '#f0f0f0' } }
            }
          }
        });
      } catch (error) {
        console.error(`Failed to fetch stats for course ${courseId}:`, error);
      }
    }

    // --- Event Listeners ---
    courseDropdown.addEventListener('change', (e) => {
      const selectedCourseId = e.target.value;
      const activeRange = document.querySelector('#rangeSelector button.active').dataset.range;
      fetchCourseStats(selectedCourseId, activeRange);
    });

    rangeSelector.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        document.querySelectorAll('#rangeSelector button').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        
        const selectedRange = e.target.dataset.range;
        const selectedCourseId = courseDropdown.value;

        if (selectedCourseId) {
          fetchCourseStats(selectedCourseId, selectedRange);
        }
      }
    });

    // --- Initial Load ---
    fetchInstructorCourses();
  </script>
</body>
</html>