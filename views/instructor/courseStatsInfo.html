<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Instructor Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #1e1e1e;
      color: #f0f0f0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .dashboard-container {
      width: 100%;
      max-width: 900px;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap; /* Helps with responsiveness */
    }
    .course-select {
      padding: 10px;
      background: #333;
      color: white;
      border: 1px solid #555;
      border-radius: 5px;
      font-size: 1em;
    }
    .range-selector button {
      padding: 8px 16px;
      margin-left: 5px;
      background: #333;
      color: white;
      border: 1px solid #555;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .range-selector button:hover {
      background: #4f46e5;
    }
    .range-selector button.active {
      background-color: #4f46e5;
      font-weight: bold;
    }
    .chart-container {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    /* CORRECTION: Added missing CSS for the course cards and container */
    .course-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      width: 100%;
    }
    .course-card {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      border-left: 5px solid #4f46e5;
    }
    .course-card h3 {
      margin-top: 0;
    }
    /* IMPROVEMENT: Added a simple style for status messages (loading/error/empty) */
    .status-message {
      text-align: center;
      color: #aaa;
      padding: 40px;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h1>Instructor Dashboard</h1>

    <div class="controls">
      <select id="courseDropdown" class="course-select"></select>
      <div id="rangeSelector" class="range-selector">
        <button data-range="7d" class="active">7 Days</button>
        <button data-range="30d">30 Days</button>
        <button data-range="1y">1 Year</button>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="enrollChart" width="600" height="300"></canvas>
    </div>

    <h2>Course Overview</h2>
    <div class="course-container" id="courseList"></div>
  </div>

  <script>
    // IMPROVEMENT: Cache DOM elements to avoid repeated lookups
    const courseDropdown = document.getElementById('courseDropdown');
    const courseListContainer = document.getElementById('courseList');
    const chartCanvas = document.getElementById('enrollChart');
    const rangeSelector = document.getElementById('rangeSelector');
    const chartContainer = document.querySelector('.chart-container');

    // IMPROVEMENT: Use a locally scoped variable instead of attaching the chart to the window object
    let enrollChartInstance = null;

    async function fetchInstructorCourses() {
      // IMPROVEMENT: Added a loading message
      courseListContainer.innerHTML = '<p class="status-message">Loading courses...</p>';
      
      // CORRECTION: Added try...catch block for robust error handling
      try {
        const res = await fetch('http://localhost:4000/instructor/courses2');
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const courses = await res.json();

        // Clear previous content
        courseDropdown.innerHTML = '';
        courseListContainer.innerHTML = '';

        // IMPROVEMENT: Handle the case where there are no courses
        if (courses.length === 0) {
          courseListContainer.innerHTML = '<p class="status-message">You have not created any courses yet.</p>';
          chartContainer.style.display = 'none'; // Hide chart if no courses
          return;
        }

        chartContainer.style.display = 'block'; // Ensure chart is visible

        courses.forEach(course => {
          // Populate dropdown
          const option = document.createElement('option');
          option.value = course._id;
          option.textContent = course.title;
          courseDropdown.appendChild(option);

          // Populate course cards
          const card = document.createElement('div');
          card.classList.add('course-card');
          card.innerHTML = `
            <h3>${course.title}</h3>
            <p><strong>Enrolled:</strong> ${course.enrolled_count.toLocaleString()}</p>
            <p><strong>Revenue:</strong> $${course.revenue.toLocaleString()}</p>
          `;
          courseListContainer.appendChild(card);
        });

        // Fetch stats for the first course by default
        if (courses.length > 0) {
            // Get active range from the button
            const activeRange = document.querySelector('#rangeSelector button.active').dataset.range;
            fetchCourseStats(courses[0]._id, activeRange);
        }
      } catch (error) {
        console.error("Failed to fetch instructor courses:", error);
        // IMPROVEMENT: Display an error message to the user
        courseListContainer.innerHTML = `<p class="status-message">Could not load courses. Please try again later.</p>`;
      }
    }

    async function fetchCourseStats(courseId, range = '7d') {
      // CORRECTION: Added try...catch block for robust error handling
      try {
        const res = await fetch(`http://localhost:4000/instructor/course2/${courseId}/stats?range=${range}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();

        // IMPROVEMENT: Format date labels for better readability
        const labels = data.map(d => new Date(d._id).toLocaleDateString());
        const values = data.map(d => d.enrollments);

        const ctx = chartCanvas.getContext('2d');
        // Destroy the previous chart instance if it exists
        if (enrollChartInstance) {
          enrollChartInstance.destroy();
        }

        enrollChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Enrollments',
              data: values,
              borderColor: '#4f46e5',
              fill: true,
              backgroundColor: 'rgba(79, 70, 229, 0.2)',
              tension: 0.1 // Makes the line chart smoother
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#f0f0f0' }, // Chart text color
                    grid: { color: 'rgba(255, 255, 255, 0.1)' } // Grid line color
                },
                x: {
                    ticks: { color: '#f0f0f0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: '#f0f0f0' } // Legend text color
                }
            }
          }
        });
      } catch (error) {
        console.error(`Failed to fetch stats for course ${courseId}:`, error);
        // You could also display an error message on the chart canvas
      }
    }

    // --- Event Listeners ---

    courseDropdown.addEventListener('change', (e) => {
      const selectedCourseId = e.target.value;
      const activeRange = document.querySelector('#rangeSelector button.active').dataset.range;
      fetchCourseStats(selectedCourseId, activeRange);
    });

    // IMPROVEMENT: Event listener for the new range selector buttons
    rangeSelector.addEventListener('click', (e) => {
        if(e.target.tagName === 'BUTTON') {
            // Remove 'active' class from all buttons
            document.querySelectorAll('#rangeSelector button').forEach(btn => btn.classList.remove('active'));
            // Add 'active' class to the clicked button
            e.target.classList.add('active');
            
            const selectedRange = e.target.dataset.range;
            const selectedCourseId = courseDropdown.value;

            if (selectedCourseId) {
                fetchCourseStats(selectedCourseId, selectedRange);
            }
        }
    });

    // --- Initial Load ---
    fetchInstructorCourses();
  </script>
</body>
</html>